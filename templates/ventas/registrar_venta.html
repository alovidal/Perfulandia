{% extends 'base.html' %}

{% block title %}Registrar Venta - Perfulandia SPA{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-cash-register"></i> Punto de Venta</h4>
            </div>
            <div class="card-body">
                <!-- Búsqueda de productos -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control form-control-lg" 
                               id="buscar-producto" placeholder="Buscar producto por código o nombre..." 
                               autocomplete="off">
                    </div>
                    <div class="col-md-4">
                        <button type="button" class="btn btn-primary btn-lg w-100" 
                                onclick="buscarProducto()">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </div>
                </div>
                
                <!-- Resultados de búsqueda -->
                <div id="resultados-busqueda" class="mb-3" style="display: none;">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Productos Encontrados</h6>
                        </div>
                        <div class="card-body p-0">
                            <div id="lista-productos"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Productos en la venta -->
                <div class="card">
                    <div class="card-header">
                        <h5>Productos en la Venta</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0" id="tabla-venta">
                                <thead class="table-light">
                                    <tr>
                                        <th>Producto</th>
                                        <th width="100">Cantidad</th>
                                        <th width="120">Precio Unit.</th>
                                        <th width="120">Subtotal</th>
                                        <th width="50">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="items-venta">
                                    <tr id="sin-productos">
                                        <td colspan="5" class="text-center py-3 text-muted">
                                            <i class="fas fa-shopping-cart"></i> Busca y agrega productos a la venta
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Panel de totales y pago -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calculator"></i> Resumen de Venta</h5>
            </div>
            <div class="card-body">
                <form id="form-venta" method="post">
                    {% csrf_token %}
                    
                    <!-- Cliente -->
                    <div class="mb-3">
                        <label for="cliente" class="form-label">Cliente</label>
                        <select class="form-select" id="cliente" name="cliente">
                            <option value="">Cliente General</option>
                            {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.get_full_name }} - {{ cliente.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Totales -->
                    <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotal">$0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>IVA (19%):</span>
                            <span id="iva">$0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Descuento:</span>
                            <div class="input-group input-group-sm" style="width: 100px;">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="descuento" 
                                       name="descuento" value="0" min="0" onchange="calcularTotales()">
                            </div>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>TOTAL:</strong>
                            <strong class="text-primary fs-4" id="total">$0</strong>
                        </div>
                    </div>
                    
                    <!-- Método de pago -->
                    <div class="mb-3">
                        <label for="metodo_pago" class="form-label">Método de Pago</label>
                        <select class="form-select" id="metodo_pago" name="metodo_pago">
                            <option value="efectivo">Efectivo</option>
                            <option value="tarjeta_debito">Tarjeta de Débito</option>
                            <option value="tarjeta_credito">Tarjeta de Crédito</option>
                            <option value="transferencia">Transferencia</option>
                        </select>
                    </div>
                    
                    <!-- Notas -->
                    <div class="mb-3">
                        <label for="notas" class="form-label">Notas</label>
                        <textarea class="form-control" id="notas" name="notas" rows="2" 
                                  placeholder="Observaciones adicionales..."></textarea>
                    </div>
                    
                    <!-- Items de la venta (hidden) -->
                    <input type="hidden" id="items_data" name="items_data">
                    
                    <!-- Botones -->
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success btn-lg" 
                                onclick="procesarVenta()" id="btn-procesar" disabled>
                            <i class="fas fa-check-circle"></i> Procesar Venta
                        </button>
                        <button type="button" class="btn btn-outline-secondary" 
                                onclick="limpiarVenta()">
                            <i class="fas fa-trash"></i> Limpiar
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Accesos rápidos -->
        <div class="card mt-3">
            <div class="card-header">
                <h6>Accesos Rápidos</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-1">
                    <a href="{% url 'ventas:lista' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-list"></i> Ver Ventas
                    </a>
                    <a href="{% url 'inventario:productos' %}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-boxes"></i> Consultar Stock
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación -->
<div class="modal fade" id="modalConfirmacion" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle"></i> Venta Procesada
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <i class="fas fa-receipt fa-3x text-success"></i>
                </div>
                <h4>¡Venta registrada exitosamente!</h4>
                <p class="mb-0">Número de venta: <strong id="numero-venta"></strong></p>
                <p class="text-muted">Total: <strong id="total-venta"></strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="imprimirFactura()">
                    <i class="fas fa-print"></i> Imprimir Factura
                </button>
                <button type="button" class="btn btn-primary" onclick="nuevaVenta()">
                    <i class="fas fa-plus"></i> Nueva Venta
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let itemsVenta = [];
let productos = {{ productos|safe }}; // Lista de productos desde el backend

function buscarProducto() {
    const termino = document.getElementById('buscar-producto').value.toLowerCase();
    const resultados = productos.filter(p => 
        p.codigo.toLowerCase().includes(termino) || 
        p.nombre.toLowerCase().includes(termino)
    );
    
    mostrarResultados(resultados);
}

function mostrarResultados(resultados) {
    const container = document.getElementById('lista-productos');
    const divResultados = document.getElementById('resultados-busqueda');
    
    if (resultados.length === 0) {
        divResultados.style.display = 'none';
        return;
    }
    
    container.innerHTML = '';
    resultados.forEach(producto => {
        const item = document.createElement('div');
        item.className = 'border-bottom p-2 producto-item';
        item.style.cursor = 'pointer';
        item.onclick = () => agregarProducto(producto);
        
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${producto.codigo}</strong> - ${producto.nombre}<br>
                    <small class="text-muted">Stock: ${producto.stock}</small>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-primary">$${producto.precio.toLocaleString()}</div>
                    <button class="btn btn-success btn-sm">
                        <i class="fas fa-plus"></i> Agregar
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(item);
    });
    
    divResultados.style.display = 'block';
}

function agregarProducto(producto) {
    // Verificar si ya está en la venta
    const existente = itemsVenta.find(item => item.producto_id === producto.id);
    
    if (existente) {
        if (existente.cantidad < producto.stock) {
            existente.cantidad++;
            existente.subtotal = existente.cantidad * existente.precio;
        } else {
            alert('No hay suficiente stock disponible');
            return;
        }
    } else {
        itemsVenta.push({
            producto_id: producto.id,
            codigo: producto.codigo,
            nombre: producto.nombre,
            precio: producto.precio,
            cantidad: 1,
            subtotal: producto.precio,
            stock: producto.stock
        });
    }
    
    actualizarTablaVenta();
    calcularTotales();
    
    // Limpiar búsqueda
    document.getElementById('buscar-producto').value = '';
    document.getElementById('resultados-busqueda').style.display = 'none';
}

function actualizarTablaVenta() {
    const tbody = document.getElementById('items-venta');
    const sinProductos = document.getElementById('sin-productos');
    
    if (itemsVenta.length === 0) {
        sinProductos.style.display = 'table-row';
        document.getElementById('btn-procesar').disabled = true;
        return;
    }
    
    sinProductos.style.display = 'none';
    document.getElementById('btn-procesar').disabled = false;
    
    // Limpiar filas existentes (excepto la de "sin productos")
    Array.from(tbody.children).forEach(row => {
        if (row.id !== 'sin-productos') {
            row.remove();
        }
    });
    
    itemsVenta.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <strong>${item.codigo}</strong><br>
                <small>${item.nombre}</small>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm" 
                       value="${item.cantidad}" min="1" max="${item.stock}"
                       onchange="cambiarCantidad(${index}, this.value)">
            </td>
            <td>$${item.precio.toLocaleString()}</td>
            <td>$${item.subtotal.toLocaleString()}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="eliminarItem(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function cambiarCantidad(index, nuevaCantidad) {
    const item = itemsVenta[index];
    const cantidad = parseInt(nuevaCantidad);
    
    if (cantidad <= 0 || cantidad > item.stock) {
        alert('Cantidad inválida');
        actualizarTablaVenta();
        return;
    }
    
    item.cantidad = cantidad;
    item.subtotal = item.cantidad * item.precio;
    
    actualizarTablaVenta();
    calcularTotales();
}

function eliminarItem(index) {
    itemsVenta.splice(index, 1);
    actualizarTablaVenta();
    calcularTotales();
}

function calcularTotales() {
    const subtotal = itemsVenta.reduce((sum, item) => sum + item.subtotal, 0);
    const descuento = parseFloat(document.getElementById('descuento').value) || 0;
    const iva = (subtotal - descuento) * 0.19;
    const total = subtotal - descuento + iva;
    
    document.getElementById('subtotal').textContent = '$' + subtotal.toLocaleString();
    document.getElementById('iva').textContent = '$' + iva.toLocaleString();
    document.getElementById('total').textContent = '$' + total.toLocaleString();
}

function procesarVenta() {
    if (itemsVenta.length === 0) {
        alert('Agrega productos a la venta');
        return;
    }
    
    // Preparar datos para enviar
    document.getElementById('items_data').value = JSON.stringify(itemsVenta);
    
    // Enviar formulario
    document.getElementById('form-venta').submit();
}

function limpiarVenta() {
    if (confirm('¿Estás seguro de que quieres limpiar la venta actual?')) {
        itemsVenta = [];
        actualizarTablaVenta();
        calcularTotales();
        document.getElementById('form-venta').reset();
        document.getElementById('buscar-producto').value = '';
        document.getElementById('resultados-busqueda').style.display = 'none';
    }
}

// Búsqueda en tiempo real
document.getElementById('buscar-producto').addEventListener('input', function(e) {
    if (e.target.value.length >= 2) {
        buscarProducto();
    } else {
        document.getElementById('resultados-busqueda').style.display = 'none';
    }
});

// Permitir búsqueda con Enter
document.getElementById('buscar-producto').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        buscarProducto();
    }
});
</script>
{% endblock %}
